name: ingest-dlc

on:
  schedule:
    - cron: "50 4 * * *"
    - cron: "45 8 * * *"
    - cron: "35 17 * * *"
    - cron: "35 21 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest
    concurrency:
      group: ingest-pages
      cancel-in-progress: false
    env:
      SOURCE_REPO: Ressurd/steam-hotdeal
    steps:
      - name: Checkout data repo
        uses: actions/checkout@v4
      - name: Check gh-pages branch
        id: ghpages
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Checkout gh-pages
        if: steps.ghpages.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.SOURCE_REPO_TOKEN }}
          path: source
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: source/package-lock.json
      - name: Install dependencies
        run: npm ci
        working-directory: source
      - name: Restore cached json
        if: steps.ghpages.outputs.exists == 'true'
        run: |
          mkdir -p source/public/detail source/public/state
          if [ -d gh-pages/detail ]; then
            rsync -a gh-pages/detail/ source/public/detail/
          fi
          if [ -d gh-pages/state ]; then
            rsync -a gh-pages/state/ source/public/state/
          fi
      - name: Run ingest (dlc)
        run: npm run ingest
        working-directory: source
        env:
          INGEST_MODE: dlc
          INGEST_DATA_SOURCE: "json"
          STEAM_MAX_DLC: "500"
          STEAM_FETCH_ATTEMPTS: "6"
          STEAM_DESC_LANGS: "english,koreana"
          STEAM_FETCH_USD: "1"
          STEAM_USD_CC: "US"
          STEAM_FETCH_REVIEWS: "0"
          STEAM_FETCH_PLAYERS: "0"
          INGEST_SKIP_RECENT_HOURS: "24"
          INGEST_SKIP_RECENT_BUFFER: "2000"
          INGEST_DLC_NONDISCOUNT_DAYS: "7"
          DETAIL_CACHE_STORAGE: "local"
          LIST_CACHE_STORAGE: "none"
          PRICE_HISTORY_STORAGE: "none"
          PLAYER_HISTORY_STORAGE: "none"
      - name: Prepare Pages output
        run: |
          rm -rf pages-out
          mkdir -p pages-out
          if [ -d gh-pages ]; then
            rsync -a --exclude .git gh-pages/ pages-out/
          fi
          if [ -d source/public/detail ]; then
            rsync -a --delete source/public/detail/ pages-out/detail/
          fi
          if [ -d source/public/state ]; then
            rsync -a --delete source/public/state/ pages-out/state/
          fi
          if [ ! -f pages-out/index.html ]; then
            printf "data\n" > pages-out/index.html
          fi
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: pages-out
          clean: true
